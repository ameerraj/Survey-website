<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Credibility Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Basic styling for Likert scale */
        .likert-scale label {
            display: block;
            text-align: center;
            cursor: pointer;
            min-width: 3rem; /* Ensure labels have some minimum width */
        }
        .likert-scale input[type="radio"] {
            display: none; /* Hide the actual radio button */
        }
        .likert-scale input[type="radio"]:checked + span {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            font-weight: 600;
        }
         /* Style for the review labels */
        .review-label {
            background-color: #f3f4f6; /* Gray-100 */
            color: #4b5563; /* Gray-600 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            display: inline-block; /* Make it wrap content nicely */
            border: 1px solid #d1d5db; /* Gray-300 */
        }
        .review-label.technical {
             background-color: #dbeafe; /* Blue-100 */
             color: #1d4ed8; /* Blue-700 */
             border-color: #93c5fd; /* Blue-300 */
        }
        /* Hide elements by default */
       .hidden-section {
            display: none;
       }
       /* Simple loader */
        .loader {
            border: 4px solid #f3f4f6; /* Gray-100 */
            border-top: 4px solid #3b82f6; /* Blue-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full max-w-2xl">

        <!-- Introduction/Consent Section -->
        <div id="intro-section">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">Welcome to the Article Credibility Study</h1>
            <p class="text-gray-700 mb-4">
                Thank you for participating in this study. We are interested in understanding how people evaluate online content.
                You will be asked a few demographic questions, and then you will read several short laptop reviews and rate their credibility.
                Your responses will be anonymous and used for research purposes only.
            </p>
            <p class="text-gray-700 mb-6">
                Participation is voluntary, and you can withdraw at any time. By clicking "Start", you consent to participate.
            </p>
            <button id="start-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 font-semibold">
                Start
            </button>
        </div>

        <!-- Demographics Section -->
        <div id="demographics-section" class="hidden-section">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">About You</h2>
            <form id="demographics-form">
                <div class="mb-4">
                    <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age:</label>
                    <input type="number" id="age" name="age" required min="18" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender:</label>
                    <select id="gender" name="gender" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="" disabled selected>Select...</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non-binary">Non-binary</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="education" class="block text-sm font-medium text-gray-700 mb-1">Highest Education Level:</label>
                    <select id="education" name="education" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="" disabled selected>Select...</option>
                        <option value="high_school">High School or equivalent</option>
                        <option value="some_college">Some College, no degree</option>
                        <option value="associates">Associate Degree</option>
                        <option value="bachelors">Bachelor's Degree</option>
                        <option value="masters">Master's Degree</option>
                        <option value="doctorate">Doctorate or Professional Degree</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 font-semibold">
                    Next
                </button>
            </form>
             <p id="demographics-error" class="text-red-600 text-sm mt-2 hidden">Please fill out all fields.</p>
        </div>

        <!-- Review Section -->
        <div id="review-section" class="hidden-section">
            <h2 id="review-title" class="text-xl font-semibold mb-2 text-gray-800">Review X of Y</h2>
            <div id="review-label-container" class="mb-2">
                <!-- Label will be inserted here by JS -->
            </div>
            <div id="review-content" class="bg-gray-50 p-4 rounded-md border border-gray-200 mb-6 text-gray-800 leading-relaxed min-h-[150px]">
                <!-- Review text will be inserted here by JS -->
            </div>

            <form id="ratings-form">
                <!-- Credibility Rating -->
                <div class="mb-6">
                    <p class="block text-sm font-medium text-gray-700 mb-2">"This article is credible."</p>
                    <div class="flex justify-between items-center likert-scale space-x-1 sm:space-x-2">
                        <span class="text-xs sm:text-sm text-gray-600">Strongly Disagree</span>
                        <div class="flex">
                            <label> <input type="radio" name="ratingCredibility" value="1" required> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">1</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="2"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">2</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="3"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">3</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="4"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">4</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="5"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">5</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="6"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">6</span> </label>
                            <label> <input type="radio" name="ratingCredibility" value="7"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">7</span> </label>
                        </div>
                        <span class="text-xs sm:text-sm text-gray-600">Strongly Agree</span>
                    </div>
                </div>

                <!-- Trustworthiness Rating -->
                <div class="mb-6">
                     <p class="block text-sm font-medium text-gray-700 mb-2">"This article is trustworthy."</p>
                    <div class="flex justify-between items-center likert-scale space-x-1 sm:space-x-2">
                         <span class="text-xs sm:text-sm text-gray-600">Strongly Disagree</span>
                         <div class="flex">
                            <label> <input type="radio" name="ratingTrustworthiness" value="1" required> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">1</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="2"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">2</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="3"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">3</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="4"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">4</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="5"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">5</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="6"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">6</span> </label>
                            <label> <input type="radio" name="ratingTrustworthiness" value="7"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">7</span> </label>
                        </div>
                        <span class="text-xs sm:text-sm text-gray-600">Strongly Agree</span>
                    </div>
                </div>

                 <!-- Well-Written Rating -->
                 <div class="mb-6">
                     <p class="block text-sm font-medium text-gray-700 mb-2">"This article is well-written."</p>
                    <div class="flex justify-between items-center likert-scale space-x-1 sm:space-x-2">
                         <span class="text-xs sm:text-sm text-gray-600">Strongly Disagree</span>
                         <div class="flex">
                            <label> <input type="radio" name="ratingWellWritten" value="1" required> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">1</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="2"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">2</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="3"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">3</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="4"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">4</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="5"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">5</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="6"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">6</span> </label>
                            <label> <input type="radio" name="ratingWellWritten" value="7"> <span class="block border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-100 text-sm">7</span> </label>
                        </div>
                        <span class="text-xs sm:text-sm text-gray-600">Strongly Agree</span>
                    </div>
                </div>

                 <p id="rating-error" class="text-red-600 text-sm mt-2 hidden">Please select a rating for all questions.</p>

                <button id="next-review-button" type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 font-semibold">
                    Next Review
                </button>
            </form>
        </div>

        <!-- Submission Loading Section -->
        <div id="loading-section" class="hidden-section text-center">
            <p class="text-gray-700 mb-4">Submitting your responses...</p>
            <div class="loader"></div>
        </div>

        <!-- Thank You Section -->
        <div id="thank-you-section" class="hidden-section text-center">
            <h1 class="text-2xl font-bold mb-4 text-green-600">Thank You!</h1>
            <p class="text-gray-700">Your responses have been recorded successfully.</p>
            <p class="text-xs text-gray-500 mt-4">User ID: <span id="display-user-id"></span></p> <!-- Display user ID -->
        </div>

         <!-- Error Section -->
        <div id="error-section" class="hidden-section text-center">
            <h1 class="text-2xl font-bold mb-4 text-red-600">Error</h1>
            <p class="text-gray-700" id="error-message">Could not submit responses. Please try again later.</p>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        // ** MODIFICATION START **
        // Directly include your Firebase configuration object here
        // Replace with your actual Firebase config details!
        const firebaseConfig = {
          apiKey: "AIzaSyBRSBhy6Exwkv0XouU547zEy7e5zqP02JY",
          authDomain: "survey-website-a728a.firebaseapp.com",
          projectId: "survey-website-a728a",
          storageBucket: "survey-website-a728a.firebasestorage.app", // Corrected field name
          messagingSenderId: "14331803341",
          appId: "1:14331803341:web:471a537075889a51d81b84",
          measurementId: "G-79LRHKKPPE" // Optional
        };
        // ** MODIFICATION END **

        // Use a default appId if __app_id is not available (useful for local testing)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'standalone-html-app-id';


        // Enable Firestore logging for debugging
        setLogLevel('debug');

        // --- App State ---
        let app;
        let auth;
        let db;
        let userId = null; // Will be set after auth
        let assignedGroup = null; // 1: Control, 2: Legal, 3: Technical
        let currentReviewIndex = 0;
        let participantData = {
            demographics: {},
            responses: []
        };

        // --- Reviews Data ---
        // !!! REPLACE WITH YOUR ACTUAL REVIEWS !!!
        // Add more reviews as needed (aim for a balance of human/ai)
        const allReviews = [
            { id: 'h1', type: 'human', text: "Just got the new XPS 15 and it's a beast. The screen is gorgeous, perfect for photo editing. Performance is top-notch for coding and even some light gaming. Battery life is decent, could be better under heavy load, but it charges fast. Build quality feels premium. A bit pricey, but worth it if you need power and portability. Highly recommend!" },
            { id: 'ai1', type: 'ai', text: "The computational device designated Model X presents a high-resolution display optimal for visual tasks. Its processing capabilities facilitate efficient execution of complex software, including development environments and recreational simulations. Energy persistence is adequate for typical usage patterns, with rapid recharge cycles mitigating downtime. The chassis construction employs superior materials, reflecting a premium market position. Financial outlay is considerable, yet justifiable for users requiring substantial performance metrics within a mobile form factor." },
             { id: 'h2', type: 'human', text: "Needed a budget laptop for college, picked up the Acer Aspire 5. Honestly, pretty impressed for the price. It's not fancy, but it runs Word, Chrome, and Zoom just fine. Keyboard is okay, trackpad is a bit flimsy. Screen is fine for notes, not great for movies. Battery gets me through most of my classes. Gets the job done without breaking the bank." },
            { id: 'ai2', type: 'ai', text: "The Acer Aspire 5 represents an economical solution for academic users. It demonstrates proficiency in operating standard productivity software such as word processors, web browsers, and video conferencing applications. The tactile input mechanism is functional, though the pointing device exhibits some structural flexibility. Visual output is suitable for text-based tasks but lacks vibrancy for media consumption. Power endurance generally aligns with scholastic schedules. It fulfills core requirements within its designated price category." },
             { id: 'h3', type: 'human', text: "MacBook Air M3: Blazing fast, silent, and the battery lasts FOREVER. Seriously, I charge it like once every couple of days with normal use. Screen is great, keyboard is comfy. macOS takes some getting used to if you're from Windows, but it's smooth. Expensive, yeah, but the performance and battery life are unreal. Perfect for students or anyone who needs a reliable, portable machine." },
            { id: 'ai3', type: 'ai', text: "Apple's MacBook Air featuring the M3 processor delivers exceptional speed and operates silently due to its fanless design. Battery longevity is a standout feature, often exceeding multi-day usage intervals under standard conditions. The display offers high fidelity, and the keyboard provides comfortable typing ergonomics. The operating system, macOS, offers a fluid user experience, although it may require adaptation for users migrating from Windows environments. While positioned at a premium price point, its performance and extended battery duration establish it as a compelling option for academic and mobile professional use cases requiring dependability and portability." }
        ];
        let shuffledReviews = []; // Will hold the randomized reviews for the current user

        // --- DOM Elements ---
        // Ensure DOM elements are accessed only after the DOM is fully loaded
        let introSection, demographicsSection, reviewSection, loadingSection, thankYouSection, errorSection, errorMessage, displayUserId;
        let startButton, demographicsForm, demographicsError, ratingsForm, ratingError, reviewTitle, reviewLabelContainer, reviewContent, nextReviewButton;

         // Function to get DOM elements safely
         function getDOMElements() {
            introSection = document.getElementById('intro-section');
            demographicsSection = document.getElementById('demographics-section');
            reviewSection = document.getElementById('review-section');
            loadingSection = document.getElementById('loading-section');
            thankYouSection = document.getElementById('thank-you-section');
            errorSection = document.getElementById('error-section');
            errorMessage = document.getElementById('error-message');
            displayUserId = document.getElementById('display-user-id');
            startButton = document.getElementById('start-button');
            demographicsForm = document.getElementById('demographics-form');
            demographicsError = document.getElementById('demographics-error');
            ratingsForm = document.getElementById('ratings-form');
            ratingError = document.getElementById('rating-error');
            reviewTitle = document.getElementById('review-title');
            reviewLabelContainer = document.getElementById('review-label-container');
            reviewContent = document.getElementById('review-content');
            nextReviewButton = document.getElementById('next-review-button');
         }


        // --- Functions ---
        function showSection(sectionId) {
             // Ensure elements are available before trying to modify them
            if (!introSection) getDOMElements(); // Get elements if not already done

            [introSection, demographicsSection, reviewSection, loadingSection, thankYouSection, errorSection].forEach(section => {
                 if (section) { // Check if the element exists
                    if (section.id === sectionId) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                 } else {
                     console.error(`Element with potential ID matching "${sectionId}" or others not found during showSection call.`);
                 }
            });
        }

        function showError(message) {
            // Ensure elements are available
            if (!errorMessage || !errorSection) getDOMElements();

            if (errorMessage && errorSection) {
                errorMessage.textContent = message;
                showSection('error-section');
            }
            console.error("Experiment Error:", message);
        }


        // Shuffle array in place (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function assignGroupAndShuffleReviews() {
            assignedGroup = Math.floor(Math.random() * 3) + 1; // 1, 2, or 3
            console.log("Assigned Group:", assignedGroup);
            shuffledReviews = [...allReviews]; // Create a copy
            shuffleArray(shuffledReviews); // Randomize review order
            console.log("Shuffled Reviews:", shuffledReviews.map(r => r.id));
        }

        function displayCurrentReview() {
            // Ensure elements are available
             if (!reviewTitle) getDOMElements();

            if (currentReviewIndex >= shuffledReviews.length) {
                submitAllData();
                return;
            }

            const review = shuffledReviews[currentReviewIndex];

             // Check if elements exist before accessing properties
             if (reviewTitle) reviewTitle.textContent = `Review ${currentReviewIndex + 1} of ${shuffledReviews.length}`;
             if (reviewContent) reviewContent.textContent = review.text;

            // Clear previous label and form
             if (reviewLabelContainer) reviewLabelContainer.innerHTML = '';
             if (ratingsForm) ratingsForm.reset();
             if (ratingError) ratingError.classList.add('hidden'); // Hide error message


            // Determine and display label based on group and review type
            let labelText = '';
            let labelType = 'none'; // To store in data
            let labelClass = 'review-label'; // CSS class

            if (review.type === 'ai') {
                if (assignedGroup === 2) {
                    labelText = 'This content was generated by AI.';
                    labelType = 'legal';
                } else if (assignedGroup === 3) {
                    // Simulate detector confidence (could be randomized or fixed)
                    const confidence = Math.floor(Math.random() * 11) + 90; // 90-100%
                    labelText = `Our AI detector flags this as ${confidence}% AI-generated.`;
                    labelType = 'technical';
                    labelClass += ' technical'; // Add specific class for technical label
                }
            } // No label for human reviews or control group AI reviews

            if (labelText && reviewLabelContainer) {
                const labelElement = document.createElement('span');
                labelElement.textContent = labelText;
                labelElement.className = labelClass;
                reviewLabelContainer.appendChild(labelElement);
            }

             // Update button text for the last review
             if (nextReviewButton) {
                if (currentReviewIndex === shuffledReviews.length - 1) {
                    nextReviewButton.textContent = 'Submit All Responses';
                } else {
                    nextReviewButton.textContent = 'Next Review';
                }
             }


             participantData.responses[currentReviewIndex] = { // Pre-populate response structure
                reviewId: review.id,
                reviewType: review.type,
                labelShown: labelType
            };

            showSection('review-section');
        }

        async function submitAllData() {
            showSection('loading-section');
            console.log("Submitting data:", participantData);

            if (!db) {
                showError("Database connection not established.");
                return;
            }
            if (!userId) {
                // If submitting without full auth, generate a temporary ID
                userId = `anon-${crypto.randomUUID()}`;
                console.warn("User not fully authenticated, using temporary ID:", userId);
                 // showError("User authentication failed.");
                 // return; // Decide if submission should proceed without full auth
            }

             // Ensure userId is added to the data payload right before submission
            const dataToSave = {
                ...participantData.demographics, // Spread demographics data directly
                userId: userId, // Ensure userId is included
                assignedGroup: assignedGroup,
                responses: participantData.responses,
                timestamp: serverTimestamp() // Add server timestamp
            };


            try {
                 // Construct the full collection path including appId
                 // Using public path as suggested in requirements for experiment data
                 // ** Using a simpler path for standalone deployment **
                 // const collectionPath = `artifacts/${appId}/public/data/experimentResponses`;
                const collectionPath = `experimentResponses/${appId}`; // Simpler path
                const responsesCol = collection(db, collectionPath);

                console.log("Saving to collection:", collectionPath);
                console.log("Data payload:", dataToSave);

                const docRef = await addDoc(responsesCol, dataToSave);
                console.log("Document written with ID: ", docRef.id);
                 if (displayUserId) displayUserId.textContent = userId; // Show user ID on thank you page
                showSection('thank-you-section');
            } catch (error) {
                console.error("Error adding document: ", error);
                showError(`Failed to submit responses: ${error.message}. Please check console.`);
            }
        }

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
             // Moved config check here to ensure showError can be called safely
             if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) { // Added check for apiKey
                 // Check if showError is available, otherwise log and alert
                 if (typeof showError === 'function') {
                    showError("Firebase configuration is missing or invalid. Cannot initialize.");
                 } else {
                     console.error("Firebase configuration is missing or invalid. Cannot initialize.");
                     alert("Critical Error: Firebase configuration missing or invalid.");
                 }
                 // ** MODIFICATION START: Removed the return false here **
                 // return false;
                 // ** MODIFICATION END **
             }

             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialized successfully.");

                // Sign in the user - For standalone, anonymous auth is usually sufficient
                 console.log("Attempting anonymous sign in...");
                 await signInAnonymously(auth);

                // Listen for auth state changes to get the user ID
                return new Promise((resolve) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User signed in anonymously, UID:", userId);
                            resolve(true); // Firebase is ready
                        } else {
                            console.error("Anonymous sign-in failed.");
                            // Decide if you want to block or allow submission with a temp ID
                            // For simplicity, let's allow it for now but log a warning.
                            console.warn("Proceeding without full anonymous auth. A temporary ID will be used on submit.");
                            userId = null; // Ensure userId is null if auth fails initially
                            resolve(true); // Still resolve true to allow the flow to continue
                            // Optionally call showError("Authentication failed, but proceeding.")
                        }
                    }, (error) => {
                        console.error("Auth state change error:", error);
                         showError(`Authentication error: ${error.message}`);
                        resolve(false); // Firebase auth failed
                    });
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                 showError(`Firebase initialization failed: ${error.message}`);
                return false; // Firebase init failed
            }
        }

        // --- Event Listeners Setup ---
        // Use DOMContentLoaded to ensure elements exist before adding listeners
         document.addEventListener('DOMContentLoaded', () => {
             getDOMElements(); // Get all DOM elements once the DOM is ready

             // Now safely add event listeners
             if(startButton) {
                startButton.addEventListener('click', () => {
                    // Initialize Firebase first
                    initializeFirebase().then(success => {
                        if (success) {
                            assignGroupAndShuffleReviews(); // Assign group and shuffle reviews only after successful auth
                            showSection('demographics-section');
                        }
                        // If !success, showError has already been called
                    });
                });
             } else {
                 console.error("Start button not found.");
             }


             if(demographicsForm) {
                demographicsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (demographicsError) demographicsError.classList.add('hidden'); // Hide previous errors
                    const formData = new FormData(demographicsForm);
                    const age = formData.get('age');
                    const gender = formData.get('gender');
                    const education = formData.get('education');

                    let formIsValid = true;
                    let errorMsg = "Please fill out all fields.";

                    if (!age || !gender || !education) {
                        formIsValid = false;
                    } else if (parseInt(age) < 18) {
                         formIsValid = false;
                         errorMsg = "You must be 18 or older to participate.";
                    }


                    if (!formIsValid && demographicsError) {
                        demographicsError.textContent = errorMsg;
                        demographicsError.classList.remove('hidden');
                        return;
                    }

                    participantData.demographics = { age: parseInt(age), gender, education }; // Store age as number
                    console.log("Demographics collected:", participantData.demographics);
                    displayCurrentReview(); // Show the first review
                });
             } else {
                 console.error("Demographics form not found.");
             }


            if(ratingsForm) {
                ratingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                   if (ratingError) ratingError.classList.add('hidden'); // Hide previous errors
                    const formData = new FormData(ratingsForm);
                    const ratingCredibility = formData.get('ratingCredibility');
                    const ratingTrustworthiness = formData.get('ratingTrustworthiness');
                    const ratingWellWritten = formData.get('ratingWellWritten');

                    if (!ratingCredibility || !ratingTrustworthiness || !ratingWellWritten) {
                        if (ratingError) ratingError.classList.remove('hidden');
                        return; // Stop if not all ratings are selected
                    }

                    // Save ratings for the current review
                    if (participantData.responses[currentReviewIndex]) {
                        participantData.responses[currentReviewIndex].ratingCredibility = parseInt(ratingCredibility);
                        participantData.responses[currentReviewIndex].ratingTrustworthiness = parseInt(ratingTrustworthiness);
                        participantData.responses[currentReviewIndex].ratingWellWritten = parseInt(ratingWellWritten);
                        console.log(`Ratings for review ${currentReviewIndex + 1} collected:`, participantData.responses[currentReviewIndex]);

                        currentReviewIndex++;
                        displayCurrentReview(); // Display next review or submit
                    } else {
                        console.error("Error: Response structure not initialized for index", currentReviewIndex);
                        showError("An internal error occurred while saving ratings.");
                    }
                });
            } else {
                 console.error("Ratings form not found.");
            }

            // --- Initial Load ---
             showSection('intro-section'); // Show intro first
         });


    </script>

</body>
</html>

